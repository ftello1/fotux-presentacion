<section>
  <h2>Calculadora lumínica y retorno de inversión</h2>
  <div class="grid-form">
    <div><label>Selecciona luminaria Fotux</label>
      <select id="preset">
        <option value="hb">Campana Industrial (interior)</option>
        <option value="tipoIV">Proyector Área Tipo IV</option>
        <option value="tipoII">Vial Tipo II</option>
        <option value="custom">Personalizado</option>
      </select>
    </div>
    <div><label>Flujo por luminaria (lm)</label><input type="number" id="flujo" value="42000"></div>
    <div><label>Potencia por luminaria (W)</label><input type="number" id="potencia" value="200"></div>
    <div><label>Largo (m)</label><input type="number" id="largo" value="30"></div>
    <div><label>Ancho (m)</label><input type="number" id="ancho" value="20"></div>
    <div><label>Altura montaje (m)</label><input type="number" id="altura" value="8"></div>
    <div><label>Lux objetivo</label><input type="number" id="lux" value="300"></div>
    <div><label>MF</label><input type="number" id="mf" value="0.8" step="0.01"></div>
    <div><label>UF</label><input type="number" id="uf" value="0.6" step="0.01"></div>
    <div><label>Horas/día</label><input type="number" id="hpd" value="12"></div>
    <div><label>Días/año</label><input type="number" id="dpa" value="300"></div>
    <div><label>Valor kWh ($)</label><input type="number" id="kwh" value="120"></div>
    <div><label>Costo por luminaria ($)</label><input type="number" id="costoLum" value="150000"></div>
    <div><label>Potencia sistema anterior (W)</label><input type="number" id="potenciaAnt" value="400"></div>

    <div class="result">
      <strong>Resultados</strong>
      <div class="kpi">
        <div><strong>Cantidad:</strong> <span id="kpiN">0</span></div>
        <div><strong>Disposición:</strong> <span id="kpiDisp">0 × 0</span></div>
        <div><strong>Lux estimados:</strong> <span id="kpiLux">0</span> lx</div>
        <div><strong>Potencia total:</strong> <span id="kpiPtot">0</span> W</div>
        <div><strong>Consumo anual:</strong> <span id="kpiEnergia">0</span> kWh</div>
        <div><strong>Costo anual:</strong> $<span id="kpiCosto">0</span></div>
        <div><strong>Ahorro anual:</strong> $<span id="kpiAhorro">0</span></div>
        <div><strong>Payback:</strong> <span id="kpiPayback">0</span> años</div>
        <div><strong>Espaciamiento:</strong> <span id="kpiEsp">Sx 0 m, Sy 0 m</span></div>
      </div>
    </div>

    <div style="grid-column:1/-1">
      <label>Plano (top view) — distribución propuesta</label>
      <canvas id="plano" width="1000" height="640"></canvas>
    </div>
  </div>
</section>

<script>
(function(){
  const $=id=>document.getElementById(id);
  const preset=$('preset'), flujo=$('flujo'), potencia=$('potencia'),
        largo=$('largo'), ancho=$('ancho'), altura=$('altura'),
        lux=$('lux'), mf=$('mf'), uf=$('uf'),
        hpd=$('hpd'), dpa=$('dpa'), kwh=$('kwh'),
        costoLum=$('costoLum'), potenciaAnt=$('potenciaAnt');

  const kpiN=$('kpiN'), kpiDisp=$('kpiDisp'), kpiLux=$('kpiLux'),
        kpiPtot=$('kpiPtot'), kpiEnergia=$('kpiEnergia'),
        kpiCosto=$('kpiCosto'), kpiAhorro=$('kpiAhorro'),
        kpiPayback=$('kpiPayback'), kpiEsp=$('kpiEsp');
  const canvas=$('plano'), ctx=canvas.getContext('2d');

  function applyPreset(){
    const p=preset.value;
    if(p==='hb'){ flujo.value=42000; potencia.value=200; uf.value=0.65; }
    if(p==='tipoIV'){ flujo.value=30000; potencia.value=200; uf.value=0.45; }
    if(p==='tipoII'){ flujo.value=18000; potencia.value=150; uf.value=0.40; }
  }

  function spacing(H,tipo){
    if(tipo==='hb'||tipo==='HB') return {sx:1.3*H, sy:1.3*H};
    if(tipo==='tipoII'||tipo==='TII') return {sx:3.6*H, sy:1.1*H};
    return {sx:2.6*H, sy:1.6*H}; // tipoIV
  }

  function gridFor(N,L,W){
    const r=L/W; let ny=Math.ceil(Math.sqrt(N/r)); let nx=Math.ceil(N/ny); return {nx,ny};
  }

  function update(){
    const L=+largo.value, W=+ancho.value, H=+altura.value;
    const E=+lux.value, MF=+mf.value, UF=+uf.value;
    const F=+flujo.value, P=+potencia.value;
    const horas=+hpd.value, dias=+dpa.value, kwhVal=+kwh.value;
    const costo=+costoLum.value, Pant=+potenciaAnt.value;

    const area=L*W;
    const N=Math.max(1, Math.ceil((E*area)/(F*UF*MF)));
    const {nx,ny}=gridFor(N,L,W);
    const Nreal=nx*ny;

    const Eest=(Nreal*F*UF*MF)/area;
    const Ptot=Nreal*P;
    const kWhAnual=(Ptot/1000)*horas*dias;
    const costoAnual=kWhAnual*kwhVal;
    const kWhAnt=(Nreal*Pant/1000)*horas*dias;
    const ahorroAnual=(kWhAnt - kWhAnual)*kwhVal;
    const inversion=Nreal*costo;
    const pb=(ahorroAnual>0)?(inversion/ahorroAnual):Infinity;

    kpiN.textContent=Nreal;
    kpiDisp.textContent=`${nx} × ${ny}`;
    kpiLux.textContent=Eest.toFixed(0);
    kpiPtot.textContent=Ptot.toFixed(0);
    kpiEnergia.textContent=kWhAnual.toFixed(0);
    kpiCosto.textContent=costoAnual.toFixed(0);
    kpiAhorro.textContent=ahorroAnual.toFixed(0);
    kpiPayback.textContent=(pb===Infinity)?'∞':pb.toFixed(1);
    const {sx,sy}=spacing(H,preset.value);
    const Sx=(nx>1)?(L/nx):sx, Sy=(ny>1)?(W/ny):sy;
    kpiEsp.textContent=`Sx ${Sx.toFixed(2)} m, Sy ${Sy.toFixed(2)} m`;

    drawPlan(L,W,nx,ny);
  }

  function drawPlan(L,W,nx,ny){
    ctx.clearRect(0,0,canvas.width,canvas.height);
    if(L<=0||W<=0) return;
    const margin=24, maxW=canvas.width-2*margin, scale=maxW/L;
    const targetH=Math.round(W*scale+2*margin);
    if(canvas.height!==targetH){ canvas.height=Math.min(900,Math.max(320,targetH)); }

    // Área
